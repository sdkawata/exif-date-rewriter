<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EXIF Date Rewriter</title>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #fafafa;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    input[type="datetime-local"] {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      max-width: 300px;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #dropzone {
      margin-top: 1rem;
      padding: 2rem;
      border: 2px dashed #ccc;
      border-radius: 8px;
      text-align: center;
      color: #666;
      transition: all 0.2s;
    }
    #dropzone.dragover {
      border-color: #007bff;
      background: #e7f1ff;
      color: #007bff;
    }
    #log {
      margin-top: 1.5rem;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1rem;
      height: 250px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #666; }
  </style>
</head>
<body>
  <h1>EXIF Date Rewriter</h1>

  <div class="form-group">
    <label for="newDate">書き換える日時</label>
    <input type="datetime-local" id="newDate">
  </div>

  <button id="selectDir">ディレクトリを選択して実行</button>

  <div id="dropzone">または、ここにフォルダをドラッグ＆ドロップ</div>

  <div id="log"><span class="info">ログがここに表示されます</span></div>

  <script>
    const logEl = document.getElementById('log');
    const log = (msg, type = '') => {
      const span = document.createElement('span');
      span.className = type;
      span.textContent = msg;
      logEl.appendChild(span);
      logEl.appendChild(document.createElement('br'));
      logEl.scrollTop = logEl.scrollHeight;
    };

    const clearLog = () => {
      logEl.innerHTML = '';
    };

    const fileToDataURL = (file) => new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(file);
    });

    const dataURLtoBlob = (dataUrl) => {
      const [header, base64] = dataUrl.split(',');
      const mime = header.match(/:(.*?);/)[1];
      const binary = atob(base64);
      const array = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
      return new Blob([array], { type: mime });
    };

    const formatExifDate = (date) => {
      const d = new Date(date);
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}:${pad(d.getMonth()+1)}:${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    };

    const btn = document.getElementById('selectDir');
    const dropzone = document.getElementById('dropzone');
    let isProcessing = false;

    const processDirectoryHandle = async (dirHandle) => {
      const dateInput = document.getElementById('newDate').value;
      if (!dateInput) {
        alert('日時を指定してください');
        return;
      }

      if (isProcessing) return;
      isProcessing = true;

      const exifDate = formatExifDate(dateInput);
      clearLog();
      log(`設定する日時: ${exifDate}`, 'info');

      btn.disabled = true;
      btn.textContent = '処理中...';
      dropzone.textContent = '処理中...';

      try {
        let processed = 0;
        let failed = 0;

        const processDirectory = async (dirHandle, path = '') => {
          for await (const entry of dirHandle.values()) {
            const entryPath = path ? `${path}/${entry.name}` : entry.name;

            if (entry.kind === 'directory') {
              await processDirectory(entry, entryPath);
            } else if (entry.kind === 'file' && /\.jpe?g$/i.test(entry.name)) {
              try {
                const file = await entry.getFile();
                const dataUrl = await fileToDataURL(file);

                const exifObj = piexif.load(dataUrl);
                const oldDate = exifObj.Exif[piexif.ExifIFD.DateTimeOriginal] || '(なし)';
                exifObj.Exif[piexif.ExifIFD.DateTimeOriginal] = exifDate;
                exifObj.Exif[piexif.ExifIFD.DateTimeDigitized] = exifDate;

                const exifBytes = piexif.dump(exifObj);
                const newDataUrl = piexif.insert(exifBytes, dataUrl);

                const writable = await entry.createWritable();
                await writable.write(dataURLtoBlob(newDataUrl));
                await writable.close();

                processed++;
                log(`✓ ${entryPath}: ${oldDate} → ${exifDate}`, 'success');
              } catch (e) {
                failed++;
                log(`✗ ${entryPath}: ${e.message}`, 'error');
              }
            }
          }
        };

        await processDirectory(dirHandle);

        log(`完了: ${processed}件成功, ${failed}件失敗`, 'info');
      } catch (e) {
        log(`エラー: ${e.message}`, 'error');
      } finally {
        isProcessing = false;
        btn.disabled = false;
        btn.textContent = 'ディレクトリを選択して実行';
        dropzone.textContent = 'または、ここにフォルダをドラッグ＆ドロップ';
      }
    };

    // ボタンクリック
    btn.addEventListener('click', async () => {
      try {
        const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        await processDirectoryHandle(dirHandle);
      } catch (e) {
        if (e.name !== 'AbortError') {
          log(`エラー: ${e.message}`, 'error');
        }
      }
    });

    // ドラッグ＆ドロップ
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');

      const items = [...e.dataTransfer.items];
      for (const item of items) {
        const handle = await item.getAsFileSystemHandle();
        if (handle && handle.kind === 'directory') {
          await processDirectoryHandle(handle);
          break;
        }
      }
    });
  </script>
</body>
</html>
